<!DOCTYPE html>
<html>
  <head>
    <title>Ceagle-I: CI from Eagle Eye</title>
    <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" title="no title" charset="utf-8">
  </head>
  <body>
    <div id="container">
      <div class="box size00"></div>
    </div>
    <script src="js/jquery-2.0.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery-ext.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery.nested.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
    $(function(){
      $("#container").nested({minWidth: 50});
      if (typeof(Worker) === 'undefined') {
        throw 'Sorry, No Worker Support for your browser. Please use the latest version of Chrome or Firefox or Safari'
      }
      
      monitor = new Worker('js/ci.monitor.js');
      
      monitor.onmessage = function(event) {
        var boxes = []
        $.each(event.data, function(index, value) {
          $.getJSON(value.url+'/lastBuild/api/json', function(data2) {
            if ($('div[data-jobname="'+value.name+'"]').length) {
              if (data2.building == 'true') {
                $('div[data-jobname="'+value.name+'"]').removeClass('success failed').addClass('building');
              } else {
                $('div[data-jobname="'+value.name+'"]').removeClass('success failed').addClass(data2.result.toLowerCase());
              }
            } else {
              var box = document.createElement('div');
              box.className = 'box size' + Math.floor(($.textMetrics(value.name)+50.0)/40) + '1 '+data2.result.toLowerCase();
              box.dataset.jobname = value.name;
              box.innerText = value.name
              boxes.push( box );
              $('#container').append(boxes).nested('append', boxes);
            }
          });
        });
      };
      
      $.getJSON('http://ci.jruby.org/api/json/', function(data) {
        var activeJobs = $.grep(data.jobs, function(value){
          return value.color !== 'disabled'
        });
        monitor.postMessage(activeJobs);
      });
    });
    </script>
  </body>
</html> 